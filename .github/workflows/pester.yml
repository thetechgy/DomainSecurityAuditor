name: Pester

on:
  pull_request:
    paths:
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - "Tests/**"
      - ".github/workflows/pester.yml"
  push:
    branches:
      - develop
      - main
    paths:
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - "Tests/**"
      - ".github/workflows/pester.yml"
  workflow_dispatch:

permissions:
  contents: read

env:
  PESTER_VERSION: '5.7.1'

jobs:
  test:
    name: Run Pester tests
    runs-on: ubuntu-latest

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            www.powershellgallery.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            actions.githubusercontent.com:443

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate pinned Pester version
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          $null = Find-Module -Name 'Pester' -RequiredVersion '${{ env.PESTER_VERSION }}' -Repository PSGallery -ErrorAction Stop
          Write-Host "Using pinned Pester version ${{ env.PESTER_VERSION }}"

      - name: Cache Pester module
        uses: actions/cache@v5
        with:
          path: ~/.local/share/powershell/Modules/Pester
          key: pester-${{ runner.os }}-${{ env.PESTER_VERSION }}
          restore-keys: |
            pester-${{ runner.os }}-

      - name: Install Pester
        shell: pwsh
        run: |
          $moduleName = 'Pester'
          $requiredVersion = [Version]$env:PESTER_VERSION

          $installed = Get-Module -ListAvailable -Name $moduleName | Where-Object { $_.Version -eq $requiredVersion }
          if (-not $installed) {
              Install-Module -Name $moduleName -RequiredVersion $requiredVersion.ToString() -Scope CurrentUser -Force -AllowClobber
          }

          Get-Module -ListAvailable -Name $moduleName | Where-Object { $_.Version -eq $requiredVersion } |
              Select-Object -First 1 |
              Format-List Name, Version, ModuleBase

      - name: Run Pester tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $resultsPath = Join-Path -Path $PWD -ChildPath 'Output/TestResults'
          if (-not (Test-Path -Path $resultsPath)) {
              New-Item -ItemType Directory -Path $resultsPath -Force | Out-Null
          }

          if (-not (Test-Path -Path 'Tests')) {
              Write-Host 'No Pester tests found (Tests folder missing). Skipping.'
              exit 0
          }

          $testFiles = Get-ChildItem -Path 'Tests' -Filter '*.ps1' -File -Recurse -ErrorAction SilentlyContinue
          if (-not $testFiles) {
              Write-Host 'No Pester test files found under Tests. Skipping.'
              exit 0
          }

          $requiredVersion = [Version]$env:PESTER_VERSION
          Import-Module -Name Pester -RequiredVersion $requiredVersion.ToString() -Force

          $config = [PesterConfiguration]::Default
          $config.Run.Path = 'Tests'
          $config.Run.PassThru = $true
          $config.Output.Verbosity = 'Detailed'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputFormat = 'JUnitXml'
          $config.TestResult.OutputPath = Join-Path -Path $resultsPath -ChildPath 'PesterResults.xml'
          $coverageTargets = @(
              'DomainSecurityAuditor.psm1'
              'Public'
              'Private'
              'Examples'
          ) | Where-Object { Test-Path -Path $_ }
          if ($coverageTargets) {
              $config.CodeCoverage.Enabled = $true
              $config.CodeCoverage.OutputFormat = 'JaCoCo'
              $config.CodeCoverage.OutputPath = Join-Path -Path $resultsPath -ChildPath 'PesterCoverage.xml'
              $config.CodeCoverage.Path = $coverageTargets
          }
          else {
              $config.CodeCoverage.Enabled = $false
              Write-Host 'No coverage targets found; skipping code coverage.'
          }

          $result = Invoke-Pester -Configuration $config
          $result | Format-List -Property *

          if ($result.FailedCount -gt 0) {
              throw "Pester reported $($result.FailedCount) failed tests."
          }

      - name: Upload Pester results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pester-results
          path: Output/TestResults/*.xml
          retention-days: 14
          if-no-files-found: warn
